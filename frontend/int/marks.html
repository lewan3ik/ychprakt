<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учебная информационная система</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Дополнительные стили для новых элементов */

        .box{
            display: none;
        }
        .filters-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
            font-size: 14px;
            min-width: 200px;
        }
        
        .btn-view {
            padding: 8px 16px;
            background-color: #4e73df;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-view:hover {
            background-color: #3a5bc7;
        }
        .grade-cell{
            position: relative;
            cursor: pointer;
        }
        .mark{
            position: absolute;
            top: 0;
            left: 11px;
        }
        .box{
            display: none;
        }
        .filters-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
            font-size: 14px;
            min-width: 200px;
        }
        
        .btn-view {
            padding: 8px 16px;
            background-color: #4e73df;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-view:hover {
            background-color: #3a5bc7;
        }
        .grade-cell{
            position: relative;
            cursor: pointer;
        }
        .mark{
            position: absolute;
            top: 0;
            left: 11px;
        }

        /* Стили для модального окна оценки */
        .grade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .grade-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .grade-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .grade-modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .grade-modal-close {
            cursor: pointer;
            font-size: 20px;
        }
        
        .grade-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .grade-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid #ddd;
            transition: all 0.2s;
        }
        
        .grade-option:hover {
            transform: scale(1.1);
        }
        
        .grade-option.selected {
            border-color: #4e73df;
            background-color: #f0f4ff;
        }
        
        .grade-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: #4e73df;
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Сайдбар -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-graduation-cap"></i> УИС</h2>
            </div>
            <div class="sidebar-menu">
        <div class="menu-category">Основное</div>
        <a href="index.html" class="menu-item">
            <i class="fas fa-home"></i> Главная
        </a>
        <a href="students.html" class="menu-item">
            <i class="fas fa-users"></i> Студенты
        </a>
        <a href="groups.html" class="menu-item">
            <i class="fas fa-layer-group"></i> Группы
        </a>
        <a href="dis.html" class="menu-item">
            <i class="fas fa-book"></i> Дисциплины
        </a>
        <a href="teach.html" class="menu-item">
            <i class="fas fa-chalkboard-teacher"></i> Преподаватели
        </a>
        
        <div class="menu-category">Учебный процесс</div>
        <a href="programdisteach.html" class="menu-item">
            <i class="fas fa-tasks"></i> Программы дисциплин
        </a>
        <a href="nagr.html" class="menu-item">
            <i class="fas fa-chart-bar"></i> Нагрузка
        </a>
        <a href="kons.html" class="menu-item">
            <i class="fas fa-question-circle"></i> Консультации
        </a>
        <a href="skip.html" class="menu-item">
            <i class="fas fa-user-times"></i> Пропуски
        </a>
        <a href="marks.html" class="menu-item active">
            <i class="fas fa-star"></i> Оценки
        </a>
    </div>
        </div>
        
        <!-- Основное содержимое -->
        <div class="main-content">
            <!-- Шапка -->
            <div class="header">
                <div class="header-title">
                    <h1>Главная</h1>
                    <p>Обзорная информация по учебному процессу</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Поиск...">
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar">ИП</div>
                        <div class="user-info">
                            <div class="user-name">Иванов П.С.</div>
                            <div class="user-role">Преподаватель</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Новые элементы фильтрации -->
            <div class="content-section">
                <div class="section-header">
                    <h2>Фильтры для просмотра оценок</h2>
                </div>
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="group-select">Группа</label>
                        <select id="group-select">
                            <option value="">Выберите группу</option>
                            <option value="1">ИТ-101</option>
                            <option value="2">ИТ-102</option>
                            <option value="3">ИТ-201</option>
                            <option value="4">ИТ-202</option>
                        </select>
                    </div>

                    
                    <button class="btn-view" id="view-marks-btn">
                        <i class="fas fa-star"></i> Просмотреть оценки
                    </button>
                </div>
            </div>
            
            <div class="scroll-container box">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">№</th>
                        <th rowspan="2" class="student-name">Студент</th>
                        <th rowspan="2">ср. балл</th>
                        <th class="date-header">04.09<div class="day-type">Тест</div></th>
                        <th class="date-header">05.09</th>
                        <th class="date-header">06.09</th>
                        <th class="date-header">07.09<div class="day-type">Прак</div></th>
                        <th class="date-header">08.09<div class="day-type">Доклад</div></th>
                        <th class="date-header">12.09<div class="day-type">Прак</div></th>
                        <th class="date-header">13.09<div class="day-type">Тест</div></th>
                        <th class="date-header">14.09<div class="day-type">Прак</div></th>
                        <th class="date-header">15.09</th>
                        <th class="date-header">16.09</th>
                        <th class="date-header">19.09</th>
                        <th class="date-header">21.09<div class="day-type">За мес</div></th>
                        <th class="date-header">22.09</th>
                        <th class="date-header">25.09</th>
                    </tr>
                </thead>
                <tbody id="studentsTable">
                    <tr>
                        <td class="row-number">1</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-2" data-grade="2">2</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell"></td>
                    </tr>
                    <tr>
                        <td class="row-number">2</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">3</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">4</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                    </tr>
                    <tr>
                        <td class="row-number">5</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">6</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">7</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">8</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell grade-4" data-grade="4">4</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                    <tr>
                        <td class="row-number">9</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell grade-3" data-grade="3">3</td>
                        <td class="grade-cell month-grade grade-4" data-grade="4">4</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                    </tr>
                    <tr>
                        <td class="row-number">10</td>
                        <td class="student-name"></td>
                        <td class="harv-ball">-</td>
                        <td class="grade-cell grade-2" data-grade="2">2</td>
                        <td class="grade-cell present">+</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell grade-5" data-grade="5">5</td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell"></td>
                        <td class="grade-cell month-grade grade-5" data-grade="5">5</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
        </div>
    </div>
    <div class="grade-modal" id="gradeModal">
        <div class="grade-modal-content">
            <div class="grade-modal-header">
                <div class="grade-modal-title">Изменение оценки</div>
                <div class="grade-modal-close">&times;</div>
            </div>
            <div class="grade-options">
                <div class="grade-option" data-grade="5">5</div>
                <div class="grade-option" data-grade="4">4</div>
                <div class="grade-option" data-grade="3">3</div>
                <div class="grade-option" data-grade="2">2</div>
                <div class="grade-option delete" data-grade="">Удалить</div>
            </div>
            <div class="grade-modal-footer">
                <button class="btn btn-outline" id="cancelGradeBtn">Отмена</button>
                <button class="btn btn-primary" id="saveGradeBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        const dir = '../../controllers/';
        document.addEventListener('DOMContentLoaded', function() {
            fetch(dir + 'GroupController.php?action=get')
        .then(res => {
            if (!res.ok) {
                throw new Error('Network response was not ok');
            }
            return res.json();
        })
        .then(students => {
             const tbody = document.getElementById('group-select');
            tbody.innerHTML = '<option value="">Выберите группу</option>'; // Очистка содержимого tbody
            console.log(students);
            students.forEach(student => {
                const row = `
               <option value="${student.ID}">${student.Name}</option>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(err => console.error('Failed to fetch students:', err));




document.querySelector('#view-marks-btn').addEventListener('click', () => {
    const groupSelect = document.querySelector('#group-select');
    const groupId = groupSelect.options[groupSelect.selectedIndex].value;
    
    if (!groupId) {
        alert('Пожалуйста, выберите группу');
        return;
    }

    fetch(dir + 'markController.php?action=getMarks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupId: groupId })
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        // Показываем контейнер с таблицей
   document.querySelector('.scroll-container.box').style.display = 'block';

// Создаем карту студентов и их оценок (теперь храним и ID оценки)
const studentsMap = {};
const allDates = new Set();

// Обрабатываем данные с сервера
Object.values(data).forEach(mark => {
    if (!studentsMap[mark.StudentID]) {
        studentsMap[mark.StudentID] = {
            name: mark.StudentName,
            marks: {}
        };
    }
    
    // Форматируем дату как "дд.мм"
    const formattedDate = formatDate(mark.Date);
    studentsMap[mark.StudentID].marks[formattedDate] = {
        grade: mark.Grade,  // сама оценка
        id: mark.ID         // ID оценки (должен приходить с сервера)
    };
    allDates.add(formattedDate);
});

// Сортируем даты
const sortedDates = Array.from(allDates).sort((a, b) => {
    const [dayA, monthA] = a.split('.').map(Number);
    const [dayB, monthB] = b.split('.').map(Number);
    return monthA - monthB || dayA - dayB;
});

// Получаем таблицу и очищаем её
const table = document.querySelector('.scroll-container table');
const thead = table.querySelector('thead');
const tbody = table.querySelector('tbody');

// Очищаем заголовки (оставляем первые 3 колонки)
while (thead.rows[0].cells.length > 3) {
    thead.rows[0].deleteCell(-1);
}

// Добавляем заголовки с датами
sortedDates.forEach(date => {
    const th = document.createElement('th');
    th.className = 'date-header';
    th.textContent = date;
    thead.rows[0].appendChild(th);
});

// Очищаем тело таблицы
tbody.innerHTML = '';

// Добавляем строки для каждого студента
Object.entries(studentsMap).forEach(([studentId, studentData], index) => {
    const row = tbody.insertRow();
    
    // Номер строки
    const numberCell = row.insertCell();
    numberCell.className = 'row-number';
    numberCell.textContent = index + 1;
    
    // Имя студента
    const nameCell = row.insertCell();
    nameCell.className = 'student-name';
    nameCell.textContent = studentData.name;
    
    // Средний балл
    const avgCell = row.insertCell();
    avgCell.className = 'harv-ball';
    
    // Вычисляем средний балл (только оценки, без ID)
    const grades = Object.values(studentData.marks).map(m => m.grade);
    avgCell.textContent = calculateAverage(grades);
    
    // Оценки по датам
    sortedDates.forEach(date => {
        const markData = studentData.marks[date] || { grade: '', id: null };
        const grade = markData.grade;
        const markId = markData.id;
        
        const gradeCell = row.insertCell();
        const span = document.createElement('span');
        span.classList.add('mark');
        span.textContent = grade;
        
        gradeCell.className = 'grade-cell' + (grade ? ` grade-${grade}` : '');
        gradeCell.appendChild(span);
        
        // Теперь храним ID оценки, а не саму оценку
        if (markId) {
            gradeCell.dataset.markId = markId;
        }
    });
});

addMarks();
    })
    .catch(error => {
        console.error('Ошибка загрузки оценок:', error);
        alert('Произошла ошибка при загрузке оценок');
    });
});

// Функция для форматирования даты
function formatDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `${day}.${month}`;
}

// Функция для расчета среднего балла
function calculateAverage(marks) {
    const grades = Object.values(marks).filter(grade => grade !== '');
    if (grades.length === 0) return '-';
    
    const sum = grades.reduce((total, grade) => total + parseInt(grade), 0);
    return (sum / grades.length).toFixed(1);
}
            // Обработчики для меню
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            
            // Обработчики для модальных окон (если нужно)
            const closeModalButtons = document.querySelectorAll('.close-modal, .btn-outline');
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
        });

         function addMarks() {
            const gradeModal = document.getElementById('gradeModal');
            const closeModalBtn = gradeModal.querySelector('.grade-modal-close');
            const cancelGradeBtn = document.getElementById('cancelGradeBtn');
            const saveGradeBtn = document.getElementById('saveGradeBtn');
            const gradeOptions = gradeModal.querySelectorAll('.grade-option');
            
            let currentCell = null;
            let selectedGrade = null;

            // Обработчик клика по ячейке с оценкой
            Array.from(document.querySelector('#studentsTable').children).forEach(elem => {
                elem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('grade-cell')) {
                        currentCell = e.target;
                        const currentGrade = currentCell.querySelector('.mark')?.textContent || '';
                        
                        // Показываем модальное окно
                        gradeModal.style.display = 'flex';
                        
                        // Сбрасываем выделение
                        gradeOptions.forEach(option => {
                            option.classList.remove('selected');
                            if (option.dataset.grade === currentGrade) {
                                option.classList.add('selected');
                                selectedGrade = currentGrade;
                            }
                        });
                    }
                });
            });

            // Обработчики выбора оценки
            gradeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    gradeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedGrade = option.dataset.grade;
                });
            });

            // Закрытие модального окна
            function closeModal() {
                gradeModal.style.display = 'none';
                currentCell = null;
                selectedGrade = null;
            }

            closeModalBtn.addEventListener('click', closeModal);
            cancelGradeBtn.addEventListener('click', closeModal);

            // Сохранение оценки
            saveGradeBtn.addEventListener('click', () => {
                if (!currentCell) return;
                
                const markSpan = currentCell.querySelector('.mark') || document.createElement('span');
                markSpan.classList.add('mark');
                
                // Если выбрано "Удалить", очищаем оценку
                if (selectedGrade === '') {
                    markSpan.textContent = '';
                    currentCell.className = 'grade-cell';
                    
                    // Удаляем все классы, связанные с оценками
                    currentCell.classList.remove('grade-5', 'grade-4', 'grade-3', 'grade-2', 'present');
                } else {
                    markSpan.textContent = selectedGrade;
                    
                    // Обновляем классы ячейки
                    currentCell.className = 'grade-cell';
                    if (selectedGrade === '+') {
                        currentCell.classList.add('present');
                    } else if (!isNaN(selectedGrade)) {
                        currentCell.classList.add(`grade-${selectedGrade}`);
                    }
                }
                
                // Добавляем span с оценкой, если его нет
                if (!currentCell.contains(markSpan)) {
                    currentCell.appendChild(markSpan);
                }
                
                // AJAX-запрос для сохранения/удаления оценки на сервере
                if (currentCell.dataset.markId) {
                    const markId = currentCell.dataset.markId;
                    const url = selectedGrade === '' ? 
                        dir + 'markController.php?action=del' : 
                        dir + 'markController.php?action=update';
                    
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            markId: markId,
                            grade: selectedGrade 
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(data.data);
                            // Если оценка удалена, очищаем data-mark-id
                            if (selectedGrade === '') {
                                currentCell.removeAttribute('data-mark-id');
                            }
                        } else {
                            console.error('Ошибка:', data.error);
                        }
                    })
                    .catch(error => console.error('Ошибка:', error));
                }
                
                closeModal();
            });

            // Закрытие модального окна при клике вне его
            gradeModal.addEventListener('click', (e) => {
                if (e.target === gradeModal) {
                    closeModal();
                }
            });
        }



    </script>
</body>
</html>