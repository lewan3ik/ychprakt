fetch('../../controllers/StudentController.php?action=get')
  .then(res => {
    if (!res.ok) {
      throw new Error('Network response was not ok');
    }
    return res.json();
  })
  .then(students => {
    const tbody = document.getElementById('students');
    tbody.innerHTML = ''; // Очистка содержимого tbody

    students.forEach(student => {
      const row = `
      <tr class="elemsList" data-id="${student.ID}" data-name="${student.FullName}" 
          data-group="${student.GroupID}" data-date="${student.ExpulsionDate}">
        <td>${student.ID}</td>
        <td>${student.FullName}</td>
        <td>${student.GroupID}</td>
        <td>${student.ExpulsionDate || '-'}</td>
        <td>
          <button class="btn btn-outline edit-btn">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-outline delete-btn">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });

    // Обработчик клика для редактирования
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation(); // Предотвращаем всплытие
        const row = this.closest('tr');
        openEditModal(row);
      });
    });

    // Обработчик клика для удаления
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const studentId = this.closest('tr').dataset.id;
        if(confirm('Вы уверены, что хотите удалить этого студента?')) {
          deleteStudent(studentId);
        }
      });
    });

    // Обработчик клика по строке
    document.querySelectorAll('.elemsList').forEach(row => {
      row.addEventListener('click', function(e) {
        if(!e.target.closest('button')) { // Если клик не по кнопке
          openEditModal(this);
        }
      });
    });
  })
  .catch(err => console.error('Failed to fetch students:', err));

// Функция открытия модального окна редактирования
function openEditModal(row) {
  // Удаляем предыдущее модальное окно, если есть
  const existingModal = document.querySelector('.modal2');
  if(existingModal) existingModal.remove();

  const modalHTML = `
  <div class="modal2" id="editStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Редактировать студента</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form>
          <input type="hidden" id="editStudentId" value="${row.dataset.id}">
          <div class="form-row">
            <div class="form-group">
              <label>ФИО *</label>
              <input value="${row.dataset.name}" type="text" class="form-control" required id="editStudentName">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Группа</label>
              <select class="form-control" id="editStudentGroup">
                <option value="ИСП-31.2" ${row.dataset.group === 'ИСП-31.2' ? 'selected' : ''}>ИСП-31.2</option>
                <option value="ИСП-31.4" ${row.dataset.group === 'ИСП-31.4' ? 'selected' : ''}>ИСП-31.4</option>
                <option value="ИСВ-29.1" ${row.dataset.group === 'ИСВ-29.1' ? 'selected' : ''}>ИСВ-29.1</option>
                <option value="ИСВ-29.2" ${row.dataset.group === 'ИСВ-29.2' ? 'selected' : ''}>ИСВ-29.2</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Дата отчисления</label>
            <input value="${row.dataset.date !== '-' ? row.dataset.date : ''}" type="date" class="form-control" id="editStudentDate">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Отмена</button>
        <button class="btn btn-primary" id="saveStudentChanges">Сохранить</button>
      </div>
    </div>
  </div>`;

  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // Обработчики для модального окна
  document.querySelector('.modal2 .close-modal').addEventListener('click', closeModal);
  document.getElementById('saveStudentChanges').addEventListener('click', saveStudentChanges);
}

// Функция сохранения изменений
function saveStudentChanges() {
  const studentId = document.getElementById('editStudentId').value;
  const studentData = {
    name: document.getElementById('editStudentName').value,
    group: document.getElementById('editStudentGroup').value,
    date: document.getElementById('editStudentDate').value
  };

  fetch(`../../controllers/StudentController.php?action=updateStudent`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: studentId, ...studentData })
  })
  .then(response => response.json())
  .then(data => {
    if(data.success) {
      closeModal();
      // Обновляем список студентов
      fetchStudents();
    } else {
      alert('Ошибка при обновлении: ' + (data.error || 'Неизвестная ошибка'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Произошла ошибка при обновлении студента');
  });
}

// Функция удаления студента
function deleteStudent(studentId) {
  fetch(`../../controllers/StudentController.php?action=deleteStudent`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: studentId })
  })
  .then(response => response.json())
  .then(data => {
    if(data.success) {
      // Обновляем список студентов
      fetchStudents();
    } else {
      alert('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Произошла ошибка при удалении студента');
  });
}

// Функция закрытия модального окна
function closeModal() {
  const modal = document.querySelector('.modal2');
  if(modal) modal.remove();
}

// Функция для обновления списка студентов
function fetchStudents() {
  fetch('../../controllers/StudentController.php?action=get')
    .then(res => res.json())
    .then(students => {
      // Реализация обновления таблицы (аналогично первому fetch)
    })
    .catch(err => console.error('Error:', err));
}